---
import FormattedDate from './FormattedDate.astro';
import Image from './Image.astro';
import { hasPostAssetFile, resolvePostFilePath } from '../utils/postAssetPath.js';

const {
	data = [],
	startIndex = 0,
	pageSize = data.length || 0,
	withBehavior = true,
	linkPrefix = '/posts'
} = Astro.props;

function hasValidHeroImage(post) {
	return hasPostAssetFile({
		src: post.data.heroImage,
		pubDate: post.data.pubDate,
		category: post.data.category,
		type: 'assets'
	});
}

function getResolvedHeroImage(post) {
	return resolvePostFilePath({
		src: post.data.heroImage,
		pubDate: post.data.pubDate,
		category: post.data.category,
		type: 'assets'
	});
}

function getPostHref(post) {
	if (!withBehavior) {
		return '#';
	}

	return `${linkPrefix}/${post.slug}/`;
}

function getPostPubDate(post) {
	const { pubDate } = post.data;

	if (!withBehavior && typeof pubDate === 'string') {
		const parsedDate = new Date(pubDate);

		if (!Number.isNaN(parsedDate.getTime())) {
			return parsedDate;
		}
	}

	return pubDate;
}

console.log(data);
---

<ul class="myPostList" data-post-list={withBehavior ? '' : undefined}>
	{
		data.map((post, index) => {
			const hasHeroImage = hasValidHeroImage(post);
			const isVisibleInCurrentPage = index >= startIndex && index < startIndex + pageSize;

			return (
				<li
					class="myPostItem"
					data-post-item={withBehavior ? '' : undefined}
					data-post-index={withBehavior ? index : undefined}
					hidden={withBehavior ? !isVisibleInCurrentPage : undefined}
				>
					<a
						href={getPostHref(post)}
						class="myPostLink"
						aria-disabled={withBehavior ? undefined : 'true'}
						tabindex={withBehavior ? undefined : '-1'}
					>
						{hasHeroImage && (
							<div class="myPostTopBox">
								<Image
									className="absolute top-0 left-0 h-full"
									width="768"
									height="400"
									src={getResolvedHeroImage(post)}
									alt={`${post.data.title} 글 썸네일`}
									type="thumbnail"
								/>
								<p class="myPostCategory">{post.data.category}</p>
							</div>
						)}

						<div class:list={['myPostBottom', !hasHeroImage && 'myPostBottomNoThumb']}>
							<div class="myPostBottomInner">
								{!hasHeroImage && <p class="myPostCategory mb-3">{post.data.category}</p>}

								<div class="flex flex-col gap-y-2.5">
									<h4 class="myPostTitle">{post.data.title}</h4>
									<p class="myPostDescription">{post.data.description}</p>
								</div>
							</div>
							<div class="myPostMeta">
								<div class="flex flex-wrap items-center gap-1">
									{post.data.author && <span class="myPostAuthor">by {post.data.author}</span>}
								</div>

								<p class="myPostDate">
									<FormattedDate date={getPostPubDate(post)} />
								</p>
							</div>
						</div>
					</a>
				</li>
			);
		})
	}
</ul>
