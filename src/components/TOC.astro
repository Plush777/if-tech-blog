---
/* pages > posts > [...slug].astro에서 가져온 headings */
const { headings } = Astro.props;
---

<aside id="toc" class="sticky top-[95px] z-[100] max-[1300px]:hidden" aria-label="목차">
	<div class="tocInner">
		<ul class="flex flex-col">
			{
				headings?.map((h) => (
					<li class={`!leading-[18px] mb-4 text-sm tocDepth${h.depth}`}>
						<a class="tocLink" href={`#${h.slug}`} title={h.text}>
							{h.text}
						</a>
					</li>
				))
			}
		</ul>
	</div>
</aside>

<script>
	// @ts-nocheck
	// https://stackoverflow.com/questions/55632954/ignore-all-errors-in-a-typescript-file
	const articleInner = document.querySelector('.articleInner');

	if (articleInner) {
		const headings = articleInner.querySelectorAll('h2, h3, h4');

		headings.forEach((heading) => heading.classList.add('heading'));

		const tocInner = document.querySelector('.tocInner');
		const tocItems = document.querySelectorAll('.tocLink');
		const tags = document.querySelectorAll('.heading');
		const header = document.querySelector('#header');
		const EXTRA_OFFSET = 12;

		tocItems.forEach((item, index) => (item.dataset.index = index));
		tags.forEach((tag, index) => (tag.dataset.index = index));

		let selectedIndex = -1;

		const setActiveItem = (nextIndex) => {
			if (nextIndex < 0 || nextIndex >= tocItems.length || nextIndex === selectedIndex) return;

			tocItems[selectedIndex]?.classList.remove('active');
			selectedIndex = nextIndex;
			tocItems[selectedIndex]?.classList.add('active');
		};

		const getHeaderBottom = () => {
			if (!header) return EXTRA_OFFSET;

			return header.getBoundingClientRect().bottom + EXTRA_OFFSET;
		};

		const updateActiveFromScroll = () => {
			const headerBottom = getHeaderBottom();
			let nextIndex = 0;

			tags.forEach((tag, index) => {
				if (tag.getBoundingClientRect().top <= headerBottom) {
					nextIndex = index;
				}
			});

			setActiveItem(nextIndex);
		};

		let ticking = false;
		const handleScroll = () => {
			if (ticking) return;
			ticking = true;
			requestAnimationFrame(() => {
				updateActiveFromScroll();
				ticking = false;
			});
		};

		tocInner?.addEventListener('click', (e) => {
			if (e.target.matches('.tocLink')) {
				e.preventDefault();
				const index = Number(e.target.dataset.index);
				const target = tags[index];

				if (!target) return;

				const top = window.scrollY + target.getBoundingClientRect().top - getHeaderBottom();
				window.scrollTo({ top, behavior: 'smooth' });
				setActiveItem(index);
			}
		});

		window.addEventListener('scroll', handleScroll, { passive: true });
		window.addEventListener('resize', handleScroll);

		updateActiveFromScroll();
	}
</script>
